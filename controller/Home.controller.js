sap.ui.define(["./Basecontroller","sap/ui/core/Fragment","sap/m/MessageToast","../model/Pomodoro.model","../model/formatter"],function(e,t,s,o,i){"use strict";return e.extend("sap.ui.demo.basicTemplate.controller.Home",{formatter:i,async onInit(){o.init();o.tie(this);o.setProperty("/settings/notification/desktopNotification",await this.requestNotificationPermission());o.syncHistory();this.handleSynchronizeUserSettings();this.handleSetUserTheme()},handleToggleTimer(){const{ticking:e}=o.getProperty("/timer");if(e){s.show("Timer stopped");return o.stopTicking()}if(!e){s.show("Timer started");return o.startTicking(this)}},handleFinishCurrentPhase(){const{status:e,taskEstimation:t}=o.getData();const{msTotal:i}=o.getProperty("/settings/minFocus");const{desktopNotification:a}=o.getProperty("/settings/notification");const{ticking:n,msExpired:r,counter:d}=o.getProperty("/timer");if(n&&e.isWorking&&r<i){s.show(`Focus for at least ${(i/6e4).toFixed(0)} minutes!`)}else{o.stopTicking();o.increaseCounter(1);o.setStatusNext();if(r>i||!e.isWorking){const{task:i}=o.getData();i.status=e;i.msExpired=r;i.msEstimated=t*36e5;o.addToHistory({...i});s.show("Phase completed");if(a){this.sendNotification("Phase completed",{body:`${(r/6e4).toFixed(0)} minute/s passed. Click here and jump into the next phase`})}}else{s.show("Phase skipped")}}},handleResetCurrentPhase(){o.stopTicking();o.setStatusPrevious()},handleUpdateTaskByTaskPath(){o.updateTaskByTaskPath();this.handleCloseTaskEditDialog()},handleOpenTaskDialog(){const e=this.getView();if(!this.byId("task-dialog")){t.load({id:e.getId(),name:"sap.ui.demo.basicTemplate.view.Fragment.Task",controller:this}).then(t=>{e.addDependent(t);t.open()})}else{this.byId("task-dialog").open()}},handleCloseTaskDialog(){const e=this.byId("task-dialog");if(e){e.close()}},handleOpenHistoryDialog(){const e=this.getView();if(!this.byId("history-dialog")){t.load({id:e.getId(),name:"sap.ui.demo.basicTemplate.view.Fragment.History",controller:this}).then(t=>{e.addDependent(t);t.open()})}else{this.byId("history-dialog").open()}},handleCloseHistoryDialog(){const e=this.byId("history-dialog");if(e){e.close()}},handleOpenTaskEditDialog(e){const s=e.getSource().getBindingContext("Pomodoro").getPath();const i=o.getProperty(s);i.sPath=s;o.setProperty("/taskEditByUser",i);const a=this.getView();if(!this.byId("task-edit-dialog")){this._taskEditDialog=t.load({id:a.getId(),name:"sap.ui.demo.basicTemplate.view.Fragment.TaskEdit",controller:this}).then(e=>{a.addDependent(e);e.open()})}else{this.byId("task-edit-dialog").open()}},handleCloseTaskEditDialog(){const e=this.byId("task-edit-dialog");if(e){e.close()}},handleSynchronizeHistory(){const e=o.syncHistory();if(e){s.show("Loaded session data from history")}else{s.show("No history data found")}},handleDeleteHistory(e=false){if(e===true){s.show("All historical data has been removed from your computer")}if(e===false){s.show("Session data cleared")}this.handleCloseHistoryDialog();o.clearHistory(e)},handleExportHistory(){const{history:e}=o.getData();const t=Object.keys(e[0]);const s=(e,t)=>t===null?"":t;let i=e.map(e=>t.map(t=>JSON.stringify(e[t],s)).join(";"));i.unshift(t.join(";"));i=i.join("\r\n");const a=new Blob([i]);const n=document.createElement("a");n.href=URL.createObjectURL(a);n.download="filename.csv";document.body.appendChild(n);n.click();document.body.removeChild(n)},handleSetUserSettings(){try{o.saveUserSettings();s.show("Saved your preferences")}catch(e){s.show(`Could not save changes: ${e}`)}},handleResetUserSettings(){o.resetUserSettings();s.show("Restored standard settings. Make sure to save them")},handleSynchronizeUserSettings(){const e=o.syncUserSettings();if(e){console.log("Loaded user session data from local storage")}},handleSynchronizeMinFocus(){const{pomodoro:e,minFocus:t}=o.getProperty("/settings");if(e.msTotal<t.msTotal){o.setProperty("/settings/minFocus/msTotal",e.msTotal)}},_setActiveTaskMsExpired(e){const t=e.getSource().getValue();const s=t*(1e3*60*60).toFixed(0);o.setProperty("/taskEditByUser/msExpired",s)},_setActiveTaskMsEstimated(e){const t=e.getSource().getValue();const s=t*(1e3*60*60).toFixed(0);o.setProperty("/taskEditByUser/msEstimated",s)}})});